% !TEX root =  ../main.tex

%\subsection{Data and preprocessing}

Our dataset for evaluating our model is a collection of chemical reactions extracted from the US patent database\citep{lowe2012extraction,Lowe2017}\todo{which of these two citations?}.
%\footnote{https://bitbucket.org/dan2097/patent-reaction-extraction/downloads/} 
% \todo{not sure how to cite this} \info[]{JAB: I've put in a citation to his thesis, does this work?}\todo{MS: there is citable figshare link with DOI for the dataset, see change}
We take as our starting point the 479,035 reactions, along with the training, validation, and testing splits, 
which were used by \citet{jin2017predicting}, referred to as the USPTO dataset.
This data consists, per reaction, a group of bond changes and reaction SMILES strings \citep{weininger1988smiles}.
The bond changes indicate pairs of atoms which are connected differently in the reactants and products.
The SMILES strings encode the molecules present in a text based format.
Before we can apply our method, we perform two data preprocessing tasks 
(using the open-source chemo-informatics software RDKit \citep{rdkit}) 
in order to automatically extract paths of electron movement during a reaction, 
for a significant subset of the data.
%in order to extract a subset of data appropriate for training a model of electron movement during a reaction. 
% The remainder of this section describes those tasks.

\subsection{Reactant and reagent separation}

Typically, reaction SMILES strings are split into three parts --- reactants, reagents, and products.

The reactant molecules are those which are consumed during the course of the chemical reaction to form the  product, 
while the {\em reagents} are any additional molecules which provide context under which the reaction occurs (for example, catalysts),
but do not explicitly take part in the reaction itself; we see this in the example in Figure~\ref{fig:task-overview}.
%Each non-hydrogen atom in the USPTO dataset is assigned an atom map number, an integer which serves as an unique identifier for the atom and allows us to match particular atoms in the reactants with atoms in the products.
%\todo{maybe this is not needed now that we describe atom maps in model}

Unfortunately, the USPTO dataset as extracted does not differentiate between reagents and reactants.
We elect to preprocess the entire USPTO dataset by separating out the reagents from the reactants using the process outlined in \citet{schwaller2017found}, where we classify as a reagent any molecule for which either 
(i) none of its constituent atoms appear in the product, or 
(ii) the molecule appears in the product SMILES completely unchanged from the pre-reaction SMILES.
This allows us to properly model molecules which are included in the dataset but do not materially contribute to the reaction.

\subsection{Identifying elementary heterolytic reactions}

To train our model, it is necessary to extract a ground-truth representation of the electron paths from the SMILES strings and bond changes.
Furthermore, not every reaction in the USPTO dataset is an elementary heterolytic reaction; 
such reactions (for example, multi-step reactions) will not have a single unique path through the atoms 
which describes the movement of the electrons.

Extracting the paths and filtering the dataset is a several-step process.
The first step is to look at the bond changes present in a reaction. 
Each atom on the ends of the path will be involved in exactly one bond change;
the atoms in the middle will be involved in two. 
We can then line up bond change pairs so that neighboring pairs have one atom in common,
 with this ordering forming a path.
For instance, given the pairs "\texttt{11-13, 14-10, 10-13}" we form the unordered path "\texttt{14-10, 10-13, 13-11}".
If we are unable to form such a path, for instance due to two paths being present as a result of multiple reaction stages, then we discard the reaction.

For training our model we want to find the ordering of our path, so that we know in which direction the electrons flow.
To do this we examine the changes of the properties of the atoms at the two ends of our path. 
In particular, we look at changes in charge and attached implicit hydrogen counts. 
The gain of negative charge (or analogously the gain of hydrogen as H+ ions without changing charge) indicates that electrons have arrived at this atom, 
implying that this is the end of the path; 
vice-versa for the start of the path.
However, sometimes the difference is not available in the USPTO data, as unfortunately only major products are recorded, and so details of what happens to some of the reactant molecules' atoms may be missing.
In these cases we fall back to using an element's {\em electronegativity} to estimate the direction of our path, with more electronegative atoms attracting electrons towards them and so being at the end of the path. 
%\todo{could say we just guess if they have equal electronegativity..?}{}

The next step of filtering checks that the path alternates between add steps (+1) and remove steps (-1). 
This is done by analyzing and comparing the bond changes on the path in the reactant and product molecules. 
Reactions that involve greater than one change (for instance going from no bond between two atoms in the reactants to a double bond between the two in the products) can indicate multi-step 
reactions with identical paths, and so are discarded.
%\todo{I think we do have an example of this, which we could put in.}
Finally, we use RDKit to produce all the intermediate and final products induced by our path acting on the reactants,
to confirm the final product produced in this manner is consistent with the major product SMILES in the USPTO dataset.
% \todo{I want to say this is not needed with the other checks but not sure. Cant remember why I added it in except as an extra sanity check.}{}

The end result of this is extracted reaction paths for those entries in the USPTO dataset which 
correspond to elementary heterolytic reactions.
This comprises the majority of the dataset, containing 349,898 total reactions, of which 29,360 form the held-out test set.


