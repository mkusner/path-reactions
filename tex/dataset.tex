% !TEX root =  ../main.tex

%\subsection{Data and preprocessing}

Our dataset for evaluating our model is a collection of chemical reactions extracted from the US patent database \citep{Lowe2017}.
We take as our starting point the 479,035 reactions, along with the training, validation, and testing splits 
which were used by \citet{jin2017predicting}, referred to as the USPTO dataset.
This data consists of, per reaction, a group of bond changes and reaction SMILES strings \citep{weininger1988smiles}.
The bond changes indicate pairs of atoms which are connected differently in the reactants and products.
The SMILES strings encode the molecules present in a text based format. Before we can apply our method, we perform two data preprocessing tasks described  below (using the open-source chemo-informatics software RDKit \citep{rdkit}). 
These steps automatically extract a subset of data appropriate for training our of electron movement during a reaction.
 
\paragraph{Reactant and Reagent Seperation}
Typically, reaction SMILES strings are split into three parts --- reactants, reagents, and products.
The reactant molecules are those which are consumed during the course of the chemical reaction to form the  product, 
while the {\em reagents} are any additional molecules which provide context under which the reaction occurs (for example, catalysts),
but do not explicitly take part in the reaction itself; we see this in the example in Figure~\ref{fig:task-overview}.





Unfortunately, the USPTO dataset as extracted does not differentiate between reagents and reactants.
We elect to preprocess the entire USPTO dataset by separating out the reagents from the reactants using the process outlined in \citet{schwaller2017found}, where we classify as a reagent any molecule for which either 
(i) none of its constituent atoms appear in the product, or 
(ii) the molecule appears in the product SMILES completely unchanged from the pre-reaction SMILES.
This allows us to properly model molecules which are included in the dataset but do not materially contribute to the reaction.

\paragraph{Identifying reactions with linear electron topology}

To train our model, it is necessary to extract a ground-truth representation of the electron paths from the SMILES strings and bond changes.
Furthermore, not every reaction in the USPTO dataset has a linear electron topology; 
such reactions (for example, multi-step reactions and cycloadditions) will not have a single unique path through the atoms 
which describes the movement of the electrons. 
Figure \ref{fig:dataset_steps} shows the steps necessary to identify and extract the electron paths from reactions exhibiting electron flow topology. Further details are in Appendix \ref{sect:electron_path_identify}.


\begin{figure*}
\centering
\includegraphics[width=1.\textwidth]{imgs/dataset_steps}
\caption{
Example of how we turn SMILES reaction string into an ordered electron path, for which we can train \ourModel on. 
This consists of a series of steps: 
(1) Identify bonds that change by comparing bond triples (source node, end node, bond type) between the reactants and products. 
(2) Line up the bond changes so that one of the atoms in consecutive bond changes overlap (for reactions which do not have linear electron flow topology, such as multi-step reactions, this will not be possible and so we discard these reactions).
(3) Work out the direction of the path. A gain of charge (or analogously the gain of hydrogen as H$^+$ ions without changing charge, such as in the example shown) indicates that the electrons have arrived at this atom; and vice-versa for the start of the path.
When details about both ends of the path are missing from the SMILES string we fall back to using an element's {\em electronegativity} to estimate the direction of our path, with more electronegative atoms attracting electrons towards them and so being at the end of the path. 
(4) The extracted electron path deterministically determines a series of intermediate molecules which can be used for training \ourModel. 
Paths that do not consist of alternative add and removal steps and do not result in the final recorded product do not exhibit LEF topology and so can be discarded.
}
\label{fig:dataset_steps}
\end{figure*}

The end result of this is extracted reaction paths for those entries in the USPTO dataset which 
correspond to reactions of linear topology.
This comprises $73\%$ of the dataset, containing 349,898 total reactions, of which 29,360 form the held-out test set.






