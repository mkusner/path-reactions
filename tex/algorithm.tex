\begin{wrapfigure}{R}{0.5\textwidth}
\begin{minipage}{1.\textwidth}
\begin{algorithm}[H]
  \caption{Sampling electron paths at predict time.}
  {\bf Input:}~~Molecule $\Mc_0$, reagents $\Mc_r$, remove flag $\texttt{F}_\textrm{remove} \!=\!1$, beam width $K$, time steps $T$
  
  \begin{algorithmic}[1]
  	% Set up pool of completed paths to sort later
  	\STATE $\hat{\Pc} = \{(\emptyset, \log \continueProb{0}{0}) \}$  \COMMENT{This set will store all completed paths.}
  	
  	% Pick the first action.
    \STATE Pick top $K$ most likely initial atoms, $\Ab_0$, when ranked by their initial probabilities, $p(a_0 \mid \moleculeSet_0, \moleculeSet_r))$.
	\STATE $\Bc_0 = \emptyset$.  \COMMENT{This set will store all open paths that should be passed to next iteration.}
	\FORALL{$v \in \Ab_0$} 
		\STATE $\Bc_0 = \Bc_0 \cup \{((v), \log \continueProb{0}{0}) + p(v \mid \moleculeSet_0, \moleculeSet_r))\}$
	\ENDFOR
	
	% Then we evaluate the next stages.
	\FOR{t in (1, \ldots, T)}
		\STATE $\hat{\Bc} = \emptyset $ \COMMENT{This set will store all open paths that we evaluate.}
		
		% We take all the previous top K open paths from the previous step...
		\FORALL{$(\texttt{path}, \texttt{lprob} \in \Bc_{t-1}$} 
			
			% We evaluate their stop probability at that point and add these stopped version to the completed pool.
			\STATE $\texttt{prob\_continue} = \continueProb{t}{\texttt{path}}$
			\STATE $\hat{\Pc} = \hat{\Pc} \cup \{(\texttt{path}, \texttt{lprob} + \log (1 -  \texttt{prob\_continue}))\}$
			
			% We then see what would happen if we continued and picked another action.
			\FORALL{$v \in \Ac$}
				\STATE $\hat{\Bc} = \hat{\Bc} \cup \{( \texttt{path}^\frown (v), \texttt{lprob} + \log \texttt{prob\_continue} )\}$
			\ENDFOR
		\ENDFOR
	\ENDFOR
    
    
    %\ab^*_0]$
  	%\FORALL{atoms $\ab$ in molecule $\Mc_1$}
    %	\STATE 
    	%\STATE $i^* = \arg\min_{i \in \{1,\ldots,n\}} 
    %\ENDFOR
    \FORALL{$t$ from $1$ to $T-1$}
    	%\STATE Select predicted path $\hat{pb}_t$
    	\IF{$\texttt{F}_\textrm{remove} = 1$}
    		\STATE Sample atom $a \sim p(a_t \mid \hat{a}_{0:t-1}, \Mc_0)$% (or null action $\mathbf{0}$ if $t \neq T-1$) to $\hat{\ab}_t$, such that the bond $(\ab^*_{t-1}, \ab^*_{t})$ \emph{exists} in $\Mc_t$.
            \IF{$a$ is not `null'}
            	\STATE $\texttt{F}_\textrm{remove} = 0$
            \ENDIF
            \STATE Set $\Mc_t$ to molecule $\Mc_{t-1}$ but with bond $(\hat{a}_{t-1}, a)$ removed.
        \ELSE
        	\STATE Sample atom $a \sim p(a_t \mid \hat{a}_{0:t-1}, \Mc_0)$
            \IF{$a$ is not `null'}
            	\STATE $\texttt{F}_\textrm{remove} = 1$
            \ENDIF
            \STATE Set $\Mc_t$ to molecule $\Mc_{t-1}$ but with bond $(\hat{a}_{t-1}, a)$ added.
   		\ENDIF
        \STATE Set $\hat{a}_t = a$
        \STATE $\hat{\Pc} = [\hat{\Pc}, \hat{a}_t]$
    \ENDFOR
  \end{algorithmic}
  {\bf Output:}~~Valid path~$\hat{\Pc}$
  \label{algo:valid_path}
\end{algorithm}
\end{minipage}
\end{wrapfigure}