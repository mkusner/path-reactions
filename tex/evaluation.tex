% !TEX root =  ../main.tex

\subsection{Evaluation}

One surprising challenge is accurately defining what it means for our model to ``correctly'' predict the reaction outcome.
%Sampling from our model, or selecting high-probability candidates using beam search, yields 
In the USPTO dataset, all reactions have been ``atom mapped'', which means that integer labels have been assigned to each non-hydrogen atom in both the reactants and the products.
The representation of the reaction mechanism produced by our model is a sequence of atoms, representing the path taken by the electrons in a series of alternating steps in which bonds are broken and formed; this then can take the form of a sequence of integers.
The most straightforward approach then is to check whether the sequence of integers extracted we from the raw data (by comparing the reported major product with the reactants) is an exact match with the sequence of integers output by out model; the top-1, top-3, and top-5 accuracies are reported in \highlight{ROW OF TABLE}.

However, this underestimates the actual predictive accuracy of the model: 
although a single atom mapping is provided as part of the USPTO dataset, in general atom mappings are not unique; 
when a reactant contains some symmetries, then multiple different atom mappings are effectively equivalent.
Here this would manifest as multiple different sequences of integers which correspond to chemically identical electron paths.
An extreme example is a reaction in which one reactant is benzene, a molecule which is formed of six carbon atoms in a completely symmetric ring: while this would be present with a unique atom mapping in the dataset, any reaction path which includes one of these carbon atoms could equally well have selected any of the other five \todo{maybe toss in an inline figure with an example}.

Recent machine learning approaches to chemical reaction prediction \citep{jin2017predicting,schwaller2017found}
have evaluated whether the major product reported in the test dataset matches predicted candidate products generated by their system, independent of mechanism.
In our case, the top-5 accuracy for a particular reaction may include multiple different electron paths that ultimately yield the same product molecule.

Identifying whether two product molecules are chemically the same is equivalent to solving a graph isomorphism over the atoms and bond types, comparing the output of our system to the product molecule.
To perform this comparison, we consider an electron path as a sequence of edits performed on the reactants graph, apply these edits to define a product graph, 
and then define a deterministic mapping from the edited graph to a canonical string representation.
This is done by first Kekulizing the molecule, a process which makes explicit the location of single and double bonds in aromatic structures.
We then apply the sequence of edits to the reactants graph,
set explicit charges or hydrogen counts on the first and last atom in the electron path in order to satisfy valence constraints,
and finally strip all atom map numbers from the graph.
If this graph corresponds to a valid product molecule, we can then use RDKit to express the molecule in a canonical SMILES string format;
predicted electron paths which would yield chemically infeasible products are represented as an empty string.
We can then evaluate whether a predicted electron path matches the ground truth electron path by a string comparison.

To use our model to produce a ranked list of predicted products, we can compute the estimated canonicalized product SMILES for each of the outputs of our beam search over electron paths, removing duplicates along the way. 
These product-level accuracies are reported in \highlight{ROW OF TABLE}.

A benefit of our approach, even if the ultimate the desired goal is to predict the product molecule rather than the electron path,
is that the predicted electron paths then can serve as explanation.
For each predicted product molecule, there is at least one electron path generated by our model which produced this;
whichever of these was highest-ranked by the beam search corresponds to the maximum likelihood path, 
but we can also report the other candidate paths which would produce the sample output as alternative explanations.
\highlight{MAYBE EXAMPLE IN APPENDIX FIGURE.}

